---
title: |
  | STRT 601 
  | Applied Economics & Modeling
  | Problem Set 2
author: |
  | Hoya 1:
  | Steve Algeo, Chris Antwi, Nicole Kuker, 
  | Karan Patel, Alec Snipes
date: "September 26, 2021"
affiliation: Georgetown University
# output:
  # word_document:
  #   reference_docx: word_styles_reference4.docx
output: pdf_document
geometry: margin = 0.75in
graphics: yes
fontsize: 12pt
# linestretch: 1.5
endnote: no
---

```{r Setup, include = FALSE}
# Markdown options
knitr::opts_chunk$set(
  echo = TRUE,
	message = FALSE,
	warning = FALSE
)


# Packages
pacman::p_load(
  pacman, rio, tidyverse, magrittr, janitor,
  stargazer, 
  ivreg,
  rdd, rddensity,
  gridExtra,
  rqPen
)


# Data for RDD
score <- import("../data/STRT601-ProblemSet2-DataSet-testRD.csv")


# Data for 2SLS regression
did <- import("../data/STRT601-ProblemSet2-DataSet-sw06.csv")

```

\newpage

# Regression Discontinuity

## Question 1  
*Plot treatment as a function of the running variable. Does the graph justify sharp RDD?  *

The discontinuous nature of the treatment as a function of the pretest score is indicative of a **Sharp RDD**. The probability of treatment goes from 0 -> 1 at exactly the pretest cutoff score of 215.  
```{r Q1}
q1 <- ggplot(score, aes(x = pretest, y = treat)) +
  geom_point() + 
  geom_vline(xintercept = 215, colour = "black", linetype = 2) + 
  labs(x = "Running Variable (Pretest Score)", y = "Treatment",
       title = "Treatment vs Running Variable")
q1
```


## Question 2  
*Plot the exam score as a function of the pre-test score. What do you observe, and does this justify the use of the pre-test as a running variable?  *

In general, there is a positive, linear, and continuous relationship between pre and post test scores. Majority of the data points are clustered in the middle of the graph (pre test score = 215), indicating that those students that are very close to the cutoff value (215 points) have similar unobservable characteristics. This similarity of datapoints near the cutoff suggests pretest scores would be a good running variable.  
```{r Q2 part 1}
q2 <- ggplot(score, aes(x = pretest, y = posttest)) +
  geom_point() + 
  labs(x = "Running Variable (Pre Test Score)", y = "Outcome Variable (Post Test Score)",
       title = "Exam Score vs Pre Test Score")

q2
```


## Question 3  
*Estimate the treatment effect at the threshold using a linear model with common slopes for treated and control units. Implement with an OLS regression of the exam score on the indicator for tutoring and the pre-test score. Under what assumptions does this estimation strategy obtain a consistent estimate of the causal effect? Provide a plot of the exam scores (y-axis) and the pre-test scores (x-axis) in which you show the regression fits and the underlying scatterplot of the data. Interpret your estimate.  *

```{r Q3 part 1}
q3_lm <- lm(posttest ~ treat + pretest, data = score)
summary(q3_lm)
```

Point estimate of treatment effect: 10.968 points  
  
Assumption:  
We assume there is heterogeneity across our data set on the running variable (pre test scores). For example, we assume that the effect of the treatment has the same effect as someone that scored 214 on the pretest and someone who scored 180 on the pretest. We also assume that students on either side of the cutoff are equivalent in everything minus the treatment effect (unobservables must not change around the threshold value) (check for balance and bunching). There needs to be a discontinuity to exploit.  

```{r Q3 part 2}
q3 <- ggplot(score, aes(x = pretest, y = posttest, colour = factor(if_else(pretest > 215, 0, 1)))) +
  geom_point(alpha = 0.5) +
  geom_vline(xintercept = 215, colour = "black", linetype = 2) +
  stat_smooth(method = "lm", se = F) + 
  labs(x = "Running Variable (Pre Test Score)", y = "Outcome Variable (Post Test Score)") +
  theme(legend.position = "none")

q3
```
  
Interpretation of the estimate of the treatment effect:  
When the treatment effect is applied to students who scored under 215 on the pretest, we estimate that there is an increase in 10.968 points on the post test for those that received tutoring.  


## Question 4  
*Repeat the exercise from question 3, but this time include both the pre-test variable and the square of the pre-test variable in the regression. Does the estimate change much? And is that consistent with your expectation, given your answer to question 2?  *

The point estimate for the treatment effect did not vary much from question 3 (10.968 -> 10.72)  
This graph below suggests that the pretest variable is definitely a good candidate for a running variable to estimate the treatment effect.  
```{r Q4}
q4_lm <- lm(posttest ~ treat + pretest + square(pretest), data = score)
summary(q4_lm)

q4 <- ggplot(score, aes(x = square(pretest), y = posttest, colour = factor(if_else(square(pretest) > square(215), 0, 1)))) +
  geom_point(alpha = 0.5) +
  geom_vline(xintercept = square(215), colour = "black", linetype = 2) +
  stat_smooth(method = "lm", se = F) + 
  labs(x = "Running Variable (Pre Test Score^2)", y = "Outcome Variable (Post Test Score)") +
  theme(legend.position = "none")

q4
```


## Question 5  
*Again repeat the exercise from question 3, but this time include the control variables that are provided in the dataset. Interpret any differences you see.  *
```{r Q5}
q5_lm <- lm(posttest ~ ., score)
summary(q5_lm)
```
Treatment effect is still the same as questions 3 and 4  
Being asian and your age are significant factors in post test scores (low p values)  


## Question 6  
*Use the rdd package in R to estimate the treatment effect using a local linear regression with a triangular kernel. Note that the function RDestimate automatically uses the Imbens-Kalyanamaran optimal bandwidth calculation. Report your estimate for the treatment effect and an estimate of uncertainty.  *

Estimate of treatment effect: 10.77 points (negative because it’s showing if you do NOT have treatment effect)  
Estimate of uncertainty (bandwidth): 6.009  
```{r Q6}
results <- RDestimate(posttest ~ pretest | 
                        gender + frlunch + esol + black + white + 
                        hispanic + asian + age, 
                      cutpoint = 215, data = score)

summary(results)

plot(results)
```


## Question 7  
*How do the estimates of the treatment effect differ across your results for questions 3-6? In other words, how robust are the results to different specifications of the regression?  *

Question                           | Estimate
-----------------------------------|----------
Question 3 (pretest)               | 10.968
Question 4 (pretest^2)             | 10.720
Question 5 (all control variables) | 10.950
Question 6 (RDEstimate)            | 10.77  

As you can see from the estimates of the treatment effects above, it is clear that this running variable is robust in various specifications of the regression model. Even when covariates are introduced, the effect of the treatment is not influenced by these observed variables.  
```{r Q7}

```


## Question 8  
*Plot the age variable as a function of the running variable. What should this graph look like for RDD to be a valid research design? What do you see?  *
```{r Q8}
q8_lm <- lm(age ~ pretest, data = score)

q8 <- ggplot(score, aes(x = pretest, y = age, colour = factor(if_else(pretest > 215, 0, 1)))) +
  geom_point(alpha = 0.5) +
  geom_vline(xintercept = 215, colour = "black", linetype = 2) +
  stat_smooth(method = "lm", se = F) + 
  labs(x = "Running Variable (Pre Test Score)", y = "Age") +
  theme(legend.position = "none")
q8
```
Having a pre test score above 215 should not have discontinuous effects on a student’s age. This graph should be continuous in nature.  
From the graph above, we see no discontinuities around the cutoff value of 215, corroborating causal interpretations from earlier estimates of the treatment effect.  


## Question 9  
*One issue with RDD is manipulation, i.e., sorting around the cutoff threshold in the running variable. Plot a histogram of the running variable, drawing a vertical line at the cutoff. What would sorting around this cutoff point look like? What do you see? Use the rdplotdensity function in R to evaluate the statistical significance of any changes.  *
```{r Q9}
ggplot(score, aes(x = pretest)) +
  geom_histogram(binwidth = 2, color = "steelblue", fill = "lightblue") +
  geom_vline(xintercept = 215, colour = "black", linetype = 2) + 
  labs(x = "Running Variable (Pre Test Score)", y = "Count", 
       title = "Histogram of Running Variable")

q9 <- rdplotdensity(manip, score$pretest) # confirms that pdf is continuous - passes test
print(q9$Estl)
print(q9$Estr)
```
Passes density test  
There is bunching when you have fewer observations on one side of the cutoff, and significantly more observations on the other side of the cutoff.  
In our case, we see a semi-normal distribution. Indicating that there is no manipulation from outside variables.  
From the density plot, we can visually see that there is no bunching (indicated by the lines) and we have a statistically significant p-value.  


\newpage

# Differences-in-Differences

## Question 10  
*Use OLS to regress suicides on the treatment indicator and the control variables (income, poverty, and population). Interpret your results. Under what conditions does this provide an unbiased estimate of the causal effect?  *
```{r Q10}

```


## Question 11  
*Estimate the treatment effect with differences-in-differences by regressing suicides on the treatment indicator, state fixed effects, and year fixed effects. In a second regression, also include the control variables. Interpret your results.  *
```{r Q11}

```


## Question 12  
*Re-estimate the model (without controls) excluding state-year observations for which the divorce law revisions have been in place longer than 2 years. This can be implemented by selecting observations with* posttrend $\leq$ 2. *Repeat the analysis, cutting off the sample after 5, 10, and 15 years of treatment. What do you observe, and what does this imply for the validity of the estimates obtained for the previous question?  *
```{r Q12}

```


## Question 13  
*Now estimate an event study model. Regress suicides on state fixed effects, year fixed effects, and fixed effects for the different values of* posttrend. *The last set of fixed effects is the object of interest. Plot the values of these fixed effects, along with a confidence interval, on a graph where* posttrend *is on the horizontal axis. Interpret the graph.  *
```{r Q13}

```


## Question 14  
*To check the parallel trends assumption, reestimate the model from the previous question, this time also including fixed effects for the different value of* pretrend. *Interpret the results. Do they support the validity of the event study approach to estimation?  *
```{r Q14}

```








